<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital ICT SMK Jinjang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden { display: none !important; }
        .active-tab { border-bottom: 4px solid #1e40af; color: #1e40af; font-weight: bold; background-color: #f8fafc; }
        .loader { border-top-color: #3498db; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #signature-pad { border: 2px dashed #ccc; background: #fff; cursor: crosshair; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

    <header class="bg-white shadow-sm border-b-4 border-blue-800 p-4">
        <div class="container mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="flex items-center gap-4">
                <img src="https://i.ibb.co/Lhb8pYQ/SMK-Jinjang.jpg" alt="Logo" class="h-20 w-auto rounded shadow-sm">
                <div>
                    <h1 class="text-2xl font-black text-blue-900 tracking-tight uppercase">Digital ICT SMK Jinjang</h1>
                    <p id="display-date" class="text-gray-500 text-sm font-medium"></p>
                </div>
            </div>
            <div id="admin-badge" class="hidden bg-red-100 text-red-700 px-4 py-1 rounded-full text-xs font-bold border border-red-200 uppercase">Mod Admin</div>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8">

        <!-- HOME VIEW -->
        <div id="view-home" class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-10">
            <div onclick="showView('booking')" class="bg-white p-10 rounded-2xl shadow-xl hover:shadow-2xl hover:scale-[1.02] transition-all cursor-pointer border-t-8 border-blue-600 text-center">
                <div class="text-6xl mb-4">üìÖ</div>
                <h2 class="text-2xl font-bold text-slate-800 uppercase">Sistem Tempahan Makmal</h2>
                <p class="text-slate-500 mt-2">Klik untuk buat tempahan makmal ICT.</p>
            </div>
            <div onclick="loginAdmin()" class="bg-white p-10 rounded-2xl shadow-xl hover:shadow-2xl hover:scale-[1.02] transition-all cursor-pointer border-t-8 border-emerald-600 text-center">
                <div class="text-6xl mb-4">üì¶</div>
                <h2 class="text-2xl font-bold text-slate-800 uppercase">Sistem Inventori & Aset</h2>
                <p class="text-slate-500 mt-2">Klik untuk urus aset dan pinjaman peralatan.</p>
            </div>
        </div>

        <!-- BOOKING VIEW -->
        <div id="view-booking" class="hidden">
            <button onclick="showView('home')" class="mb-4 text-blue-600 font-bold hover:underline flex items-center gap-2">
                <span>‚Üê</span> KEMBALI KE MENU UTAMA
            </button>
            <div class="bg-white rounded-xl shadow-lg overflow-hidden border">
                <div class="flex bg-slate-100 border-b">
                    <button id="btn-booking-1" onclick="switchTab('booking', 1)" class="flex-1 py-4 font-bold uppercase active-tab">Borang Tempahan</button>
                    <button id="btn-booking-2" onclick="switchTab('booking', 2)" class="flex-1 py-4 font-bold uppercase">Rekod Tempahan</button>
                </div>
                <div id="tab-booking-1" class="p-6">
                    <form onsubmit="submitBooking(event)" class="max-w-md mx-auto space-y-4 bg-slate-50 p-6 rounded-xl border">
                        <div><label class="block text-xs font-bold text-gray-500 uppercase">Nama Guru</label><input type="text" id="book-nama" required class="w-full p-3 border rounded-lg"></div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase">Tarikh</label><input type="date" id="book-tarikh" onchange="generateStartSlots()" required class="w-full p-3 border rounded-lg"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-xs font-bold text-gray-500 uppercase">Masa Mula</label><select id="book-mula" onchange="generateEndSlots()" required class="w-full p-3 border rounded-lg"><option value="">Pilih Tarikh</option></select></div>
                            <div><label class="block text-xs font-bold text-gray-500 uppercase">Masa Tamat</label><select id="book-tamat" required class="w-full p-3 border rounded-lg"><option value="">Mula Dahulu</option></select></div>
                        </div>
                        <button type="submit" class="w-full bg-blue-700 text-white font-bold py-4 rounded-lg uppercase hover:bg-blue-800 transition-colors">Sahkan Tempahan</button>
                    </form>
                </div>
                <div id="tab-booking-2" class="hidden p-6">
                    <div class="overflow-x-auto border rounded-lg">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-800 text-white"><tr><th class="p-3">Nama Guru</th><th class="p-3">Tarikh</th><th class="p-3">Masa</th></tr></thead>
                            <tbody id="table-booking-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- INVENTORY VIEW -->
        <div id="view-inventory" class="hidden">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <button onclick="showView('home')" class="text-blue-600 font-bold hover:underline">‚Üê KELUAR SISTEM</button>
                <div class="flex bg-gray-200 rounded-lg p-1 text-xs font-bold gap-1 w-full md:w-auto">
                    <button id="btn-inventory-1" onclick="switchTab('inventory', 1)" class="flex-1 md:flex-none px-4 py-2 rounded-md uppercase active-tab">Daftar</button>
                    <button id="btn-inventory-2" onclick="switchTab('inventory', 2)" class="flex-1 md:flex-none px-4 py-2 rounded-md uppercase">Senarai</button>
                    <button id="btn-inventory-3" onclick="switchTab('inventory', 3)" class="flex-1 md:flex-none px-4 py-2 rounded-md uppercase">Pinjaman</button>
                </div>
            </div>

            <!-- Tab 1: Daftar/Edit Aset -->
            <div id="tab-inventory-1" class="bg-white p-6 rounded-xl shadow border">
                <h3 id="asset-form-title" class="font-bold text-emerald-800 mb-4 uppercase">Daftar Aset Baru</h3>
                <form onsubmit="submitAsset(event)" id="form-asset" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="hidden" id="asset-id">
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold uppercase">Jenis Aset</label>
                        <select id="asset-jenis" required class="w-full p-3 border rounded-lg">
                            <option value="Komputer">Komputer</option>
                            <option value="Laptop">Laptop</option>
                            <option value="Printer">Printer</option>
                            <option value="Toner/Ink">Toner/Ink</option>
                            <option value="Lain-lain">Lain-lain</option>
                        </select>
                    </div>
                    <div><label class="block text-xs font-bold uppercase">Jenama</label><input type="text" id="asset-jenama" required class="w-full p-3 border rounded-lg"></div>
                    <div><label class="block text-xs font-bold uppercase">Model</label><input type="text" id="asset-model" required class="w-full p-3 border rounded-lg"></div>
                    <div><label class="block text-xs font-bold uppercase">No Siri</label><input type="text" id="asset-siri" required class="w-full p-3 border rounded-lg"></div>
                    <div><label class="block text-xs font-bold uppercase">Lokasi</label><input type="text" id="asset-lokasi" required class="w-full p-3 border rounded-lg"></div>
                    <div class="md:col-span-2 flex gap-2">
                        <button type="submit" id="btn-save-asset" class="flex-1 bg-emerald-700 text-white font-bold py-3 rounded-lg uppercase hover:bg-emerald-800 transition-colors">Simpan Rekod Aset</button>
                        <button type="button" id="btn-cancel-edit" onclick="resetAssetForm()" class="hidden bg-gray-500 text-white font-bold px-6 py-3 rounded-lg uppercase">Batal</button>
                    </div>
                </form>
            </div>

            <!-- Tab 2: Senarai Aset -->
            <div id="tab-inventory-2" class="hidden bg-white p-6 rounded-xl shadow border">
                 <table class="w-full text-sm text-left">
                    <thead class="bg-slate-800 text-white">
                        <tr><th class="p-3">Aset / No Siri</th><th class="p-3 text-center">Tindakan</th></tr>
                    </thead>
                    <tbody id="table-asset-body"></tbody>
                </table>
            </div>

            <!-- Tab 3: Pinjaman -->
            <div id="tab-inventory-3" class="hidden space-y-4">
                <div class="bg-white p-6 rounded-xl shadow border">
                    <h3 class="font-bold text-blue-800 mb-4 uppercase">Borang Pinjaman Alatan</h3>
                    <form onsubmit="submitLoan(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div><label class="block text-xs font-bold uppercase">Nama Peminjam</label><input type="text" id="loan-nama" required class="w-full p-3 border rounded-lg"></div>
                        <div>
                            <label class="block text-xs font-bold uppercase">Carian Aset (No Siri / Model)</label>
                            <input type="text" id="search-asset-loan" oninput="filterLoanAssets()" placeholder="Taip untuk cari..." class="w-full p-3 border rounded-lg mb-1">
                            <select id="loan-asset" required class="w-full p-3 border rounded-lg"></select>
                        </div>
                        <div><label class="block text-xs font-bold uppercase">Tarikh Pinjam</label><input type="date" id="loan-tarikh" required class="w-full p-3 border rounded-lg"></div>
                        <div><label class="block text-xs font-bold uppercase">Tujuan</label><input type="text" id="loan-tujuan" required class="w-full p-3 border rounded-lg"></div>
                        <button type="submit" class="md:col-span-2 bg-blue-700 text-white font-bold py-3 rounded-lg uppercase">Sahkan Pinjaman</button>
                    </form>
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs text-left border mt-4">
                            <thead class="bg-gray-100"><tr><th class="p-2">Nama</th><th class="p-2">Aset</th><th class="p-2">Status</th><th class="p-2 text-center">Tindakan</th></tr></thead>
                            <tbody id="table-loan-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Tandatangan -->
    <div id="modal-signature" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[110] p-4">
        <div class="bg-white p-6 rounded-xl w-full max-w-md shadow-2xl">
            <h3 class="font-bold text-lg mb-2 uppercase">Sila Tandatangan</h3>
            <p class="text-xs text-gray-500 mb-4 italic">Tandatangan diperlukan sebelum pengesahan pemulangan.</p>
            <canvas id="signature-pad" width="400" height="200" class="w-full rounded border"></canvas>
            <div class="flex gap-2 mt-4">
                <button onclick="clearSignature()" class="flex-1 py-2 bg-gray-200 font-bold rounded">Padam</button>
                <button onclick="confirmReturn()" class="flex-1 py-2 bg-blue-700 text-white font-bold rounded">Sahkan Pulang</button>
            </div>
            <button onclick="closeSignatureModal()" class="w-full mt-2 text-xs text-gray-400 hover:underline">Batal</button>
        </div>
    </div>

    <div id="loader" class="hidden fixed inset-0 bg-white/80 flex flex-col items-center justify-center z-[100]">
        <div class="loader rounded-full border-8 border-t-8 border-blue-200 h-16 w-16 mb-2"></div>
        <p class="font-bold text-blue-900 uppercase text-xs">Sila Tunggu...</p>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbwjCjtDcEHOglGZfR4Udo1jy66yuHwGZPpRRW8DbcEvBVxHFEUBTlbqu4-jB4XH8kfnZw/exec';
        let dataTempahan = [], dataAset = [], dataPinjaman = [];
        let currentReturnId = null;

        // Signature logic
        const canvas = document.getElementById('signature-pad');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('touchstart', (e) => startDrawing(e.touches[0]));
        canvas.addEventListener('touchmove', (e) => draw(e.touches[0]));
        canvas.addEventListener('touchend', stopDrawing);

        function startDrawing(e) { isDrawing = true; draw(e); }
        function draw(e) {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.pageX) - rect.left;
            const y = (e.clientY || e.pageY) - rect.top;
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
        }
        function stopDrawing() { isDrawing = false; ctx.beginPath(); }
        function clearSignature() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

        window.onload = () => {
            const d = new Date();
            document.getElementById('display-date').innerText = d.toLocaleDateString('ms-MY', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        };

        function showView(viewId) {
            document.getElementById('view-home').classList.add('hidden');
            document.getElementById('view-booking').classList.add('hidden');
            document.getElementById('view-inventory').classList.add('hidden');
            const target = document.getElementById(`view-${viewId}`);
            if (target) {
                target.classList.remove('hidden');
                if(viewId !== 'home') refreshData();
            }
        }

        function loginAdmin() {
            const pass = prompt("Sila masukkan Kata Laluan Admin:");
            if (pass === "smkjinjang123") {
                document.getElementById('admin-badge').classList.remove('hidden');
                showView('inventory');
            } else if (pass !== null) {
                alert("Kata laluan salah.");
            }
        }

        function switchTab(section, index) {
            const max = (section === 'booking') ? 2 : 3;
            for(let i=1; i<=max; i++) {
                const tab = document.getElementById(`tab-${section}-${i}`);
                const btn = document.getElementById(`btn-${section}-${i}`);
                if(tab) tab.classList.add('hidden');
                if(btn) btn.classList.remove('active-tab');
            }
            document.getElementById(`tab-${section}-${index}`).classList.remove('hidden');
            document.getElementById(`btn-${section}-${index}`).classList.add('active-tab');
        }

        async function refreshData() {
            if(!API_URL || API_URL.includes('GANTIKAN')) {
                renderBookingTable();
                renderAssetTable();
                return;
            }
            toggleLoader(true);
            try {
                const responses = await Promise.all([
                    fetch(`${API_URL}?action=getBookings`).then(r => r.json()),
                    fetch(`${API_URL}?action=getAssets`).then(r => r.json()),
                    fetch(`${API_URL}?action=getBorrowing`).then(r => r.json())
                ]);
                dataTempahan = responses[0].data || [];
                dataAset = responses[1].data || [];
                dataPinjaman = responses[2].data || [];
                renderBookingTable();
                renderAssetTable();
                renderLoanTable();
                filterLoanAssets(); 
            } catch (e) {
                console.error("Gagal muat data:", e);
            } finally {
                toggleLoader(false);
            }
        }

        function renderBookingTable() {
            const b = document.getElementById('table-booking-body');
            if(!b) return;
            b.innerHTML = dataTempahan.length ? dataTempahan.map(x => `<tr class="border-b"><td class="p-3 font-bold">${x[0]}</td><td class="p-3">${x[1]}</td><td class="p-3 text-blue-700 font-medium">${x[2]}</td></tr>`).join('') : '<tr><td colspan="3" class="p-4 text-center">Tiada data</td></tr>';
        }

        function renderAssetTable() {
            const b = document.getElementById('table-asset-body');
            if(!b) return;
            b.innerHTML = dataAset.length ? dataAset.map(x => `
                <tr class="border-b">
                    <td class="p-3">
                        <b>[${x[1]}] ${x[2]} - ${x[3]}</b><br>
                        <span class="text-xs text-gray-500">No Siri: ${x[4]} | Lokasi: ${x[5]}</span>
                    </td>
                    <td class="p-3 text-center flex flex-col md:flex-row gap-1 justify-center">
                        <button onclick="editAsset('${x[0]}')" class="bg-amber-100 text-amber-700 text-[10px] font-bold px-2 py-1 rounded border border-amber-200">EDIT</button>
                        <button onclick="deleteAsset('${x[0]}')" class="bg-red-50 text-red-500 text-[10px] font-bold px-2 py-1 rounded border border-red-200">HAPUS</button>
                    </td>
                </tr>`).join('') : '<tr><td colspan="2" class="p-4 text-center">Tiada rekod aset</td></tr>';
        }

        function renderLoanTable() {
            const b = document.getElementById('table-loan-body');
            if(!b) return;
            b.innerHTML = dataPinjaman.length ? dataPinjaman.map(x => `
                <tr class="border-b">
                    <td class="p-2"><b>${x[1]}</b></td>
                    <td class="p-2 text-xs">${x[2]}</td>
                    <td class="p-2">${x[5] ? '<span class="text-green-600 font-bold">Pulang</span>' : '<span class="text-orange-500">Dipinjam</span>'}</td>
                    <td class="p-2 text-center">
                        ${!x[5] ? `<button onclick="openSignatureModal('${x[0]}')" class="bg-blue-600 text-white px-2 py-1 rounded text-[10px] font-bold">PULANG</button>` : '-'}
                    </td>
                </tr>`).join('') : '<tr><td colspan="4" class="p-4 text-center italic">Tiada pinjaman aktif</td></tr>';
        }

        function filterLoanAssets() {
            const term = document.getElementById('search-asset-loan').value.toLowerCase();
            const s = document.getElementById('loan-asset');
            s.innerHTML = '<option value="">-- Pilih Aset --</option>';
            dataAset.forEach(a => {
                const label = `${a[4]} - ${a[3]} (${a[2]})`.toLowerCase();
                if(label.includes(term)) {
                    s.innerHTML += `<option value="${a[0]}">${a[1]} - ${a[2]} (${a[4]})</option>`;
                }
            });
        }

        // CRUD Aset
        function editAsset(id) {
            const asset = dataAset.find(a => a[0] == id);
            if(!asset) return;
            document.getElementById('asset-id').value = asset[0];
            document.getElementById('asset-jenis').value = asset[1];
            document.getElementById('asset-jenama').value = asset[2];
            document.getElementById('asset-model').value = asset[3];
            document.getElementById('asset-siri').value = asset[4];
            document.getElementById('asset-lokasi').value = asset[5];
            
            document.getElementById('asset-form-title').innerText = "Edit Aset";
            document.getElementById('btn-save-asset').innerText = "Kemas Kini Aset";
            document.getElementById('btn-cancel-edit').classList.remove('hidden');
            switchTab('inventory', 1);
        }

        function resetAssetForm() {
            document.getElementById('form-asset').reset();
            document.getElementById('asset-id').value = "";
            document.getElementById('asset-form-title').innerText = "Daftar Aset Baru";
            document.getElementById('btn-save-asset').innerText = "Simpan Rekod Aset";
            document.getElementById('btn-cancel-edit').classList.add('hidden');
        }

        function deleteAsset(id) {
            if(confirm("Adakah anda pasti mahu memadam aset ini?")) {
                sendData({ action: 'deleteAsset', id: id });
            }
        }

        // Return Modal Logic
        function openSignatureModal(loanId) {
            currentReturnId = loanId;
            document.getElementById('modal-signature').classList.remove('hidden');
            clearSignature();
        }
        function closeSignatureModal() {
            document.getElementById('modal-signature').classList.add('hidden');
            currentReturnId = null;
        }
        function confirmReturn() {
            // Check if canvas is empty
            const blank = document.createElement('canvas');
            blank.width = canvas.width;
            blank.height = canvas.height;
            if(canvas.toDataURL() === blank.toDataURL()) {
                alert("Sila berikan tandatangan terlebih dahulu.");
                return;
            }
            sendData({ action: 'returnAsset', id: currentReturnId });
            closeSignatureModal();
        }

        async function sendData(p) {
            if(!API_URL || API_URL.includes('GANTIKAN')) { alert("Mod Demo: Data tidak disimpan."); return; }
            toggleLoader(true);
            try {
                await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(p) });
                alert("Berjaya!");
                resetAssetForm();
                setTimeout(refreshData, 1000);
            } catch (e) { alert("Ralat teknikal."); }
            toggleLoader(false);
        }

        function submitAsset(e) { 
            e.preventDefault(); 
            const id = document.getElementById('asset-id').value;
            const payload = { 
                action: id ? 'editAsset' : 'addAsset', 
                id: id,
                jenis: document.getElementById('asset-jenis').value, 
                jenama: document.getElementById('asset-jenama').value, 
                model: document.getElementById('asset-model').value, 
                nosiri: document.getElementById('asset-siri').value, 
                lokasi: document.getElementById('asset-lokasi').value 
            };
            sendData(payload); 
        }

        function submitBooking(e) { 
            e.preventDefault(); 
            sendData({ action: 'addBooking', nama: document.getElementById('book-nama').value, tarikh: document.getElementById('book-tarikh').value, masa: document.getElementById('book-mula').value + ' - ' + document.getElementById('book-tamat').value }); 
            e.target.reset(); 
        }

        function submitLoan(e) { 
            e.preventDefault(); 
            const sel = document.getElementById('loan-asset'); 
            sendData({ action: 'addBorrow', idAset: sel.value, aset: sel.options[sel.selectedIndex].text, nama: document.getElementById('loan-nama').value, tarikh: document.getElementById('loan-tarikh').value, tujuan: document.getElementById('loan-tujuan').value }); 
            e.target.reset(); 
        }

        function toggleLoader(s) { document.getElementById('loader').classList.toggle('hidden', !s); }

        // Time slots
        const ALL_SLOTS = ["07:30", "08:00", "08:30", "09:00", "09:30", "10:00", "10:30", "11:00", "11:30", "12:00", "12:30", "13:00", "13:30", "14:00", "14:30", "15:00", "15:30", "16:00", "16:30", "17:00", "17:30"];
        function generateStartSlots() {
            const s = document.getElementById('book-mula');
            s.innerHTML = '<option value="">Pilih Masa</option>';
            ALL_SLOTS.forEach(sl => { s.innerHTML += `<option value="${sl}">${sl}</option>`; });
        }
        function generateEndSlots() {
            const m = document.getElementById('book-mula').value;
            const s = document.getElementById('book-tamat');
            s.innerHTML = '<option value="">Tamat</option>';
            const idx = ALL_SLOTS.indexOf(m);
            for(let i=idx+1; i<ALL_SLOTS.length; i++) { s.innerHTML += `<option value="${ALL_SLOTS[i]}">${ALL_SLOTS[i]}</option>`; }
        }
    </script>
</body>
</html>