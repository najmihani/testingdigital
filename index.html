<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital ICT SMK Jinjang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden { display: none !important; }
        .active-tab { border-bottom: 4px solid #1e40af; color: #1e40af; font-weight: bold; background-color: #f8fafc; }
        .loader { border-top-color: #3498db; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #signature-pad { border: 2px dashed #cbd5e1; background: #ffffff; cursor: crosshair; touch-action: none; }
        @media print { .no-print { display: none !important; } .print-only { display: block !important; } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900">

    <header class="bg-white shadow-sm border-b-4 border-blue-800 p-4 no-print text-center md:text-left">
        <div class="container mx-auto flex flex-col md:flex-row items-center gap-4">
            <img src="https://i.ibb.co/Lhb8pYQ/SMK-Jinjang.jpg" alt="Logo SMK Jinjang" class="h-16 w-auto">
            <div>
                <h1 class="text-xl font-black text-blue-900 uppercase">Digital ICT SMK Jinjang</h1>
                <p id="display-date" class="text-xs text-gray-500 font-medium"></p>
            </div>
            <div id="admin-badge" class="hidden ml-auto bg-red-100 text-red-700 px-3 py-1 rounded-full text-[10px] font-bold border border-red-200 uppercase">Pentadbir</div>
        </div>
    </header>

    <main class="container mx-auto p-4 no-print">
        <div id="view-home" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
            <div onclick="showView('booking')" class="bg-white p-8 rounded-2xl shadow-md hover:shadow-lg transition-all cursor-pointer border-t-4 border-blue-600">
                <div class="text-4xl mb-2">üóìÔ∏è</div>
                <h2 class="text-lg font-bold uppercase">Tempahan Makmal</h2>
                <p class="text-sm text-slate-500">Rekod penggunaan makmal komputer.</p>
            </div>
            <div onclick="loginAdmin()" class="bg-white p-8 rounded-2xl shadow-md hover:shadow-lg transition-all cursor-pointer border-t-4 border-emerald-600">
                <div class="text-4xl mb-2">üì¶</div>
                <h2 class="text-lg font-bold uppercase">Inventori & Pinjaman</h2>
                <p class="text-sm text-slate-500">Urus aset dan pinjaman peralatan ICT.</p>
            </div>
        </div>

        <div id="view-inventory" class="hidden space-y-4">
            <div class="flex justify-between items-center">
                <button onclick="showView('home')" class="text-blue-700 font-bold text-sm">‚Üê KEMBALI</button>
                <div class="flex bg-slate-200 p-1 rounded-lg gap-1">
                    <button id="btn-inv-1" onclick="switchTab('inv', 1)" class="px-4 py-2 text-xs font-bold rounded active-tab">ASET</button>
                    <button id="btn-inv-2" onclick="switchTab('inv', 2)" class="px-4 py-2 text-xs font-bold rounded">PINJAMAN</button>
                </div>
            </div>

            <div id="tab-inv-1" class="bg-white p-6 rounded-xl shadow-sm border">
                <h3 class="font-bold text-blue-900 mb-4 uppercase text-sm">Pendaftaran Aset</h3>
                <form onsubmit="submitAsset(event)" class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <input type="text" id="asset-jenis" placeholder="Jenis (cth: Laptop)" required class="p-2 border rounded text-sm">
                    <input type="text" id="asset-jenama" placeholder="Jenama" required class="p-2 border rounded text-sm">
                    <input type="text" id="asset-siri" placeholder="No Siri" required class="p-2 border rounded text-sm">
                    <button type="submit" class="md:col-span-3 bg-emerald-600 text-white py-2 rounded font-bold text-sm hover:bg-emerald-700 uppercase">Simpan Aset</button>
                </form>
                <div class="mt-6 overflow-x-auto">
                    <table class="w-full text-left text-xs">
                        <thead class="bg-slate-50"><tr><th class="p-2">Aset</th><th class="p-2">No Siri</th><th class="p-2">Aksi</th></tr></thead>
                        <tbody id="asset-list"></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-inv-2" class="hidden space-y-4">
                <div class="bg-white p-6 rounded-xl shadow-sm border">
                    <h3 class="font-bold text-blue-900 mb-4 uppercase text-sm">Pinjaman Baru</h3>
                    <form onsubmit="submitLoan(event)" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <input type="text" id="loan-nama" placeholder="Nama Peminjam" required class="p-2 border rounded text-sm">
                        <select id="loan-asset-id" required class="p-2 border rounded text-sm bg-blue-50">
                            <option value="">-- Memuatkan Stok... --</option>
                        </select>
                        <input type="date" id="loan-tarikh" required class="p-2 border rounded text-sm">
                        <button type="submit" class="md:col-span-2 bg-blue-700 text-white py-2 rounded font-bold text-sm uppercase">Sahkan Pinjaman</button>
                    </form>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm border">
                    <h3 class="font-bold text-slate-800 mb-4 uppercase text-sm">Senarai Pinjaman Aktif</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs border-collapse">
                            <thead><tr class="border-b bg-slate-50"><th class="p-2 text-left">Peminjam</th><th class="p-2 text-left">Alatan</th><th class="p-2 text-center">Aksi</th></tr></thead>
                            <tbody id="loan-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="modal-sig" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-[50]">
        <div class="bg-white p-6 rounded-2xl w-full max-w-md">
            <h3 class="font-bold text-blue-900 mb-1 uppercase">Sahkan Pemulangan</h3>
            <p class="text-[10px] text-gray-500 mb-4 uppercase font-bold">Tandatangan di bawah:</p>
            <canvas id="signature-pad" width="400" height="200" class="w-full border rounded"></canvas>
            <div class="grid grid-cols-2 gap-2 mt-4">
                <button onclick="clearSig()" class="bg-slate-200 py-2 rounded font-bold text-xs uppercase">Padam</button>
                <button onclick="saveReturn()" class="bg-blue-700 text-white py-2 rounded font-bold text-xs uppercase">Hantar & Selesai</button>
            </div>
            <button onclick="closeSig()" class="w-full mt-4 text-[10px] text-red-500 font-bold uppercase">Batal</button>
        </div>
    </div>

    <div id="loader" class="hidden fixed inset-0 bg-white/80 flex items-center justify-center z-[100]">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-blue-100 h-10 w-10"></div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzKY09R3cc4gF40uv4UwTRGqPgq2cpZ34CcELbq2epf_z-tu8bdAkZaIo9P76VfB6e2vQ/exec';
        let assets = [], loans = [], currentLoanId = null;

        const canvas = document.getElementById('signature-pad');
        const ctx = canvas.getContext('2d');
        let drawing = false;

        canvas.addEventListener('mousedown', () => drawing = true);
        canvas.addEventListener('mouseup', () => { drawing = false; ctx.beginPath(); });
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); drawing = true; });
        canvas.addEventListener('touchend', () => { drawing = false; ctx.beginPath(); });
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); });

        function draw(e) {
            if (!drawing) return;
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            ctx.lineWidth = 2; ctx.lineCap = 'round'; ctx.strokeStyle = '#1e3a8a';
            ctx.lineTo(x, y); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(x, y);
        }

        function clearSig() { ctx.clearRect(0, 0, canvas.width, canvas.height); }
        function closeSig() { document.getElementById('modal-sig').classList.add('hidden'); }
        function openSig(id) { currentLoanId = id; document.getElementById('modal-sig').classList.remove('hidden'); clearSig(); }

        async function refresh() {
            if (!API_URL.startsWith('http')) return;
            setLoading(true);
            try {
                const rA = await fetch(API_URL + '?action=getAssets');
                const rL = await fetch(API_URL + '?action=getBorrowing');
                const resA = await rA.json();
                const resL = await rL.json();
                assets = resA.data || [];
                loans = resL.data || [];
                updateUI();
            } catch (err) { console.error(err); }
            setLoading(false);
        }

        function updateUI() {
            const al = document.getElementById('asset-list');
            al.innerHTML = assets.map(a => `
                <tr class="border-b"><td class="p-2">${a[2]}</td><td class="p-2">${a[4]}</td>
                <td class="p-2"><button onclick="deleteAsset('${a[0]}')" class="text-red-500 font-bold">HAPUS</button></td></tr>`).join('');

            const dropdown = document.getElementById('loan-asset-id');
            // Logik Stok Pintar: Ambil ID Aset dari Kolum H (Index 7)
            const borrowedIds = loans.filter(l => !l[5] || l[5] === "").map(l => String(l[7])); 
            
            const available = assets.filter(a => !borrowedIds.includes(String(a[0])));
            
            dropdown.innerHTML = '<option value="">-- Pilih Aset --</option>' + 
                available.map(a => `<option value="${a[0]}">${a[2]} (${a[4]})</option>`).join('');

            const ll = document.getElementById('loan-list');
            const activeLoans = loans.filter(l => !l[5] || l[5] === "");
            ll.innerHTML = activeLoans.length ? activeLoans.map(l => `
                <tr class="border-b"><td class="p-2 font-bold">${l[1]}</td><td class="p-2">${l[2]}</td>
                <td class="p-2 text-center"><button onclick="openSig('${l[0]}')" class="bg-blue-600 text-white px-3 py-1 rounded text-[10px] font-bold">PULANG</button></td></tr>`).join('') 
                : '<tr><td colspan="3" class="p-4 text-center text-gray-400 italic">Tiada pinjaman aktif</td></tr>';
        }

        async function saveReturn() {
            if (!currentLoanId) return;
            const sig = canvas.toDataURL('image/png');
            setLoading(true);
            try {
                const params = new URLSearchParams();
                params.append('action', 'returnAsset');
                params.append('id', currentLoanId);
                params.append('signature', sig);
                await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: params });
                closeSig();
                setTimeout(refresh, 2000);
                alert("Berjaya dipulangkan!");
            } catch (err) { alert("Ralat server!"); }
            setLoading(false);
        }

        async function postData(obj) {
            setLoading(true);
            try {
                const params = new URLSearchParams();
                for (let key in obj) params.append(key, obj[key]);
                await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: params });
                setTimeout(refresh, 1500);
            } catch (e) { alert("Gagal!"); }
            setLoading(false);
        }

        function submitAsset(e) {
            e.preventDefault();
            postData({
                action: 'addAsset',
                jenis: document.getElementById('asset-jenis').value,
                jenama: document.getElementById('asset-jenama').value,
                nosiri: document.getElementById('asset-siri').value
            });
            e.target.reset();
        }

        function submitLoan(e) {
            e.preventDefault();
            const sel = document.getElementById('loan-asset-id');
            postData({
                action: 'addBorrow',
                idAset: sel.value,
                aset: sel.options[sel.selectedIndex].text,
                nama: document.getElementById('loan-nama').value,
                tarikh: document.getElementById('loan-tarikh').value
            });
            e.target.reset();
        }

        function showView(v) {
            ['home','inventory'].forEach(i => document.getElementById('view-'+i).classList.add('hidden'));
            document.getElementById('view-'+v).classList.remove('hidden');
            if(v !== 'home') refresh();
        }

        function switchTab(s, i) {
            document.getElementById('tab-inv-1').classList.toggle('hidden', i!==1);
            document.getElementById('tab-inv-2').classList.toggle('hidden', i!==2);
            document.getElementById('btn-inv-1').classList.toggle('active-tab', i===1);
            document.getElementById('btn-inv-2').classList.toggle('active-tab', i===2);
        }

        function setLoading(s) { document.getElementById('loader').classList.toggle('hidden', !s); }

        function loginAdmin() {
            const p = prompt("Kata Laluan:");
            if (p === "smkjinjang123") {
                document.getElementById('admin-badge').classList.remove('hidden');
                showView('inventory');
            }
        }

        window.onload = () => {
            document.getElementById('display-date').innerText = new Date().toLocaleDateString('ms-MY', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
        };
    </script>
</body>
</html>