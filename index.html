const ss = SpreadsheetApp.getActiveSpreadsheet();
const sheetTempahan = ss.getSheetByName("Tempahan") || ss.insertSheet("Tempahan");
const sheetInventori = ss.getSheetByName("Inventori") || ss.insertSheet("Inventori");
const sheetPeminjaman = ss.getSheetByName("Peminjaman") || ss.insertSheet("Peminjaman");

// Inisialisasi Header - TAMBAH LAJUR TANDA TANGAN
if (sheetTempahan.getLastRow() === 0) sheetTempahan.appendRow(["Nama Guru", "Tarikh", "Masa", "Timestamp"]);
if (sheetInventori.getLastRow() === 0) sheetInventori.appendRow(["ID", "Jenis", "Jenama", "Model", "NoSiri", "Lokasi", "Catatan"]);
if (sheetPeminjaman.getLastRow() === 0) sheetPeminjaman.appendRow(["ID_Aset", "Nama Peminjam", "Aset", "Tarikh Pinjam", "Tujuan", "Tarikh Pulang", "Tanda Tangan"]);

function doGet(e) {
  const action = e.parameter.action;
  let data;
  
  if (action === "getBookings") data = sheetTempahan.getDataRange().getDisplayValues().slice(1);
  if (action === "getAssets") data = sheetInventori.getDataRange().getDisplayValues().slice(1);
  if (action === "getBorrowing") data = sheetPeminjaman.getDataRange().getDisplayValues().slice(1);
  
  return ContentService.createTextOutput(JSON.stringify(data || [])).setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  const data = JSON.parse(e.postData.contents);
  const action = data.action;

  try {
    if (action === "addBooking") {
      sheetTempahan.appendRow([data.nama, data.tarikh, data.masa, new Date()]);
    } 
    else if (action === "addAsset") {
      sheetInventori.appendRow([Utilities.getUuid(), data.jenis, data.jenama, data.model, data.nosiri, data.lokasi, ""]);
    }
    else if (action === "updateAsset") {
      const rows = sheetInventori.getDataRange().getValues();
      for(let i=1; i<rows.length; i++) {
        if(rows[i][0].toString() === data.id.toString()) {
          sheetInventori.getRange(i+1, 2, 1, 5).setValues([[data.jenis, data.jenama, data.model, data.nosiri, data.lokasi]]);
          break;
        }
      }
    }
    else if (action === "deleteAsset") {
      const rows = sheetInventori.getDataRange().getValues();
      for(let i=1; i<rows.length; i++) {
        if(rows[i][0].toString() === data.id.toString()) {
          sheetInventori.deleteRow(i + 1);
          break;
        }
      }
    }
    else if (action === "addBorrow") {
      // Lajur 6 (Pulang) dan Lajur 7 (Sign) dikosongkan pada awalnya
      sheetPeminjaman.appendRow([data.idAset, data.nama, data.aset, data.tarikh, data.tujuan, "", ""]);
    }
    else if (action === "returnAsset") {
      const rows = sheetPeminjaman.getDataRange().getValues();
      // Cari baris terakhir yang mempunyai ID Aset dan Nama Peminjam yang sama dan belum dipulangkan (lajur 6 kosong)
      for(let i=rows.length-1; i>=1; i--) {
        if(rows[i][0].toString() === data.idAset.toString() && rows[i][1] === data.nama && rows[i][5] === "") {
          sheetPeminjaman.getRange(i+1, 6).setValue(data.tarikhPulang);
          sheetPeminjaman.getRange(i+1, 7).setValue(data.tandaTangan); // Simpan Base64 Tanda Tangan
          break;
        }
      }
    }
    return ContentService.createTextOutput("Success").setMimeType(ContentService.MimeType.TEXT);
  } catch (err) {
    return ContentService.createTextOutput("Error: " + err.message).setMimeType(ContentService.MimeType.TEXT);
  }
}