<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital ICT SMK Jinjang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden { display: none !important; }
        .active-tab { border-bottom: 4px solid #1e40af; color: #1e40af; font-weight: bold; background-color: #f8fafc; }
        .loader { border-top-color: #3498db; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #signature-pad {
            border: 2px dashed #cbd5e1;
            background-color: #ffffff;
            cursor: crosshair;
            touch-action: none;
        }

        @media print {
            body * { visibility: hidden; }
            #print-section, #print-section * { visibility: visible; }
            #print-section { position: absolute; left: 0; top: 0; width: 100%; display: block !important; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

    <header class="bg-white shadow-sm border-b-4 border-blue-800 p-4 no-print">
        <div class="container mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="flex items-center gap-4">
                <img src="https://i.ibb.co/Lhb8pYQ/SMK-Jinjang.jpg" alt="Logo" class="h-20 w-auto rounded shadow-sm">
                <div>
                    <h1 class="text-2xl font-black text-blue-900 tracking-tight uppercase">Digital ICT SMK Jinjang</h1>
                    <p id="display-date" class="text-gray-500 text-sm font-medium"></p>
                </div>
            </div>
            <div id="admin-badge" class="hidden bg-red-100 text-red-700 px-4 py-1 rounded-full text-xs font-bold border border-red-200 uppercase">Admin Mode</div>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8 no-print">

        <!-- HOME VIEW -->
        <div id="view-home" class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-10">
            <div onclick="showView('booking')" class="bg-white p-10 rounded-2xl shadow-xl hover:shadow-2xl hover:scale-[1.02] transition-all cursor-pointer border-t-8 border-blue-600 group text-center">
                <div class="text-6xl mb-4">üìÖ</div>
                <h2 class="text-2xl font-bold text-slate-800 uppercase">Sistem Tempahan Makmal</h2>
                <p class="text-slate-500 mt-2">Semak jadual dan buat tempahan makmal.</p>
            </div>
            <div onclick="loginAdmin()" class="bg-white p-10 rounded-2xl shadow-xl hover:shadow-2xl hover:scale-[1.02] transition-all cursor-pointer border-t-8 border-emerald-600 group text-center">
                <div class="text-6xl mb-4">üì¶</div>
                <h2 class="text-2xl font-bold text-slate-800 uppercase">Sistem Inventori & Aset</h2>
                <p class="text-slate-500 mt-2">Daftar aset dan urus pinjaman peralatan.</p>
            </div>
        </div>

        <!-- BOOKING VIEW -->
        <div id="view-booking" class="hidden">
            <button onclick="showView('home')" class="mb-4 text-blue-600 font-bold hover:underline uppercase">‚Üê Menu Utama</button>
            <div class="bg-white rounded-xl shadow-lg overflow-hidden border">
                <div class="flex bg-slate-100 border-b">
                    <button id="btn-booking-1" onclick="switchTab('booking', 1)" class="flex-1 py-4 font-bold uppercase active-tab">Borang</button>
                    <button id="btn-booking-2" onclick="switchTab('booking', 2)" class="flex-1 py-4 font-bold uppercase">Rekod & Laporan</button>
                </div>

                <div id="tab-booking-1" class="p-6">
                    <div class="max-w-md mx-auto bg-slate-50 p-6 rounded-xl border">
                        <form onsubmit="submitBooking(event)" class="space-y-4">
                            <div><label class="block text-xs font-bold text-gray-500 uppercase">Nama Guru</label><input type="text" id="book-nama" required class="w-full p-3 border rounded-lg"></div>
                            <div><label class="block text-xs font-bold text-gray-500 uppercase">Tarikh</label><input type="date" id="book-tarikh" onchange="generateStartSlots()" required class="w-full p-3 border rounded-lg"></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-xs font-bold text-gray-500 uppercase">Mula</label><select id="book-mula" onchange="generateEndSlots()" required class="w-full p-3 border rounded-lg"><option value="">Pilih Tarikh</option></select></div>
                                <div><label class="block text-xs font-bold text-gray-500 uppercase">Tamat</label><select id="book-tamat" required class="w-full p-3 border rounded-lg"><option value="">Mula Dahulu</option></select></div>
                            </div>
                            <button type="submit" class="w-full bg-blue-700 text-white font-bold py-4 rounded-lg uppercase tracking-widest">Sahkan Tempahan</button>
                        </form>
                    </div>
                </div>

                <div id="tab-booking-2" class="hidden p-6">
                    <div class="overflow-x-auto border rounded-lg">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-800 text-white"><tr><th class="p-3">Nama Guru</th><th class="p-3">Tarikh</th><th class="p-3">Masa</th></tr></thead>
                            <tbody id="table-booking-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- INVENTORY VIEW -->
        <div id="view-inventory" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <button onclick="showView('home')" class="text-blue-600 font-bold hover:underline uppercase">‚Üê Keluar</button>
                <div class="flex bg-gray-200 rounded-lg p-1 text-xs font-bold gap-1">
                    <button id="btn-inventory-1" onclick="switchTab('inventory', 1)" class="px-4 py-2 rounded-md uppercase active-tab">Daftar</button>
                    <button id="btn-inventory-2" onclick="switchTab('inventory', 2)" class="px-4 py-2 rounded-md uppercase">Senarai</button>
                    <button id="btn-inventory-3" onclick="switchTab('inventory', 3)" class="px-4 py-2 rounded-md uppercase">Pinjaman</button>
                </div>
            </div>

            <div id="tab-inventory-1" class="bg-white p-6 rounded-xl shadow border">
                <form onsubmit="submitAsset(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="hidden" id="asset-id">
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold text-gray-500 uppercase">Jenis Aset</label>
                        <select id="asset-jenis" required class="w-full p-3 border rounded-lg">
                            <option value="">-- Pilih Jenis --</option>
                            <option value="Komputer">Komputer</option>
                            <option value="Laptop">Laptop</option>
                            <option value="Printer">Printer</option>
                            <option value="Lain-lain">Lain-lain</option>
                        </select>
                    </div>
                    <div><label class="block text-xs font-bold uppercase">Jenama</label><input type="text" id="asset-jenama" required class="w-full p-3 border rounded-lg"></div>
                    <div><label class="block text-xs font-bold uppercase">Model</label><input type="text" id="asset-model" required class="w-full p-3 border rounded-lg"></div>
                    <div><label class="block text-xs font-bold uppercase">No Siri</label><input type="text" id="asset-siri" required class="w-full p-3 border rounded-lg"></div>
                    <div><label class="block text-xs font-bold uppercase">Lokasi</label><input type="text" id="asset-lokasi" required class="w-full p-3 border rounded-lg"></div>
                    <button type="submit" class="md:col-span-2 bg-emerald-700 text-white font-bold py-3 rounded-lg uppercase">Simpan Aset</button>
                </form>
            </div>

            <div id="tab-inventory-2" class="hidden bg-white p-6 rounded-xl shadow border">
                 <table class="w-full text-sm text-left"><thead class="bg-slate-800 text-white"><tr><th class="p-3">Maklumat Aset</th><th class="p-3 text-center">Tindakan</th></tr></thead><tbody id="table-asset-body"></tbody></table>
            </div>

            <div id="tab-inventory-3" class="hidden space-y-4">
                <div class="bg-white p-6 rounded-xl shadow border">
                    <form onsubmit="submitLoan(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div><label class="block text-xs font-bold uppercase">Nama Peminjam</label><input type="text" id="loan-nama" required class="w-full p-3 border rounded-lg"></div>
                        <div><label class="block text-xs font-bold uppercase">Aset</label><select id="loan-asset" required class="w-full p-3 border rounded-lg"></select></div>
                        <div><label class="block text-xs font-bold uppercase">Tarikh</label><input type="date" id="loan-tarikh" required class="w-full p-3 border rounded-lg"></div>
                        <div><label class="block text-xs font-bold uppercase">Tujuan</label><input type="text" id="loan-tujuan" required class="w-full p-3 border rounded-lg"></div>
                        <button type="submit" class="md:col-span-2 bg-blue-700 text-white font-bold py-3 rounded-lg uppercase">Daftar Pinjaman</button>
                    </form>
                    <div class="overflow-x-auto"><table class="w-full text-xs text-left"><thead class="bg-gray-100"><tr><th class="p-2">Peminjam</th><th class="p-2">Aset</th><th class="p-2">Status</th></tr></thead><tbody id="table-loan-body"></tbody></table></div>
                </div>
            </div>
        </div>
    </main>

    <div id="loader" class="hidden fixed inset-0 bg-white/80 flex flex-col items-center justify-center z-[100]">
        <div class="loader rounded-full border-8 border-t-8 border-blue-200 h-16 w-16 mb-2"></div>
        <p class="font-bold text-blue-900 uppercase text-xs">Memproses Data...</p>
    </div>

    <script>
        // MASUKKAN URL WEB APP ANDA DI SINI
        const API_URL = https://script.google.com/macros/s/AKfycbwjCjtDcEHOglGZfR4Udo1jy66yuHwGZPpRRW8DbcEvBVxHFEUBTlbqu4-jB4XH8kfnZw/exec ;
        
        let dataTempahan = [], dataAset = [], dataPinjaman = [];

        window.onload = () => {
            document.getElementById('display-date').innerText = new Date().toLocaleDateString('ms-MY', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        };

        function showView(viewId) {
            document.getElementById('view-home').classList.add('hidden');
            document.getElementById('view-booking').classList.add('hidden');
            document.getElementById('view-inventory').classList.add('hidden');
            
            document.getElementById(`view-${viewId}`).classList.remove('hidden');
            if(viewId !== 'home') refreshData();
        }

        function switchTab(section, index) {
            const max = (section === 'booking') ? 2 : 3;
            for(let i=1; i<=max; i++) {
                document.getElementById(`tab-${section}-${i}`).classList.add('hidden');
                document.getElementById(`btn-${section}-${i}`).classList.remove('active-tab');
            }
            document.getElementById(`tab-${section}-${index}`).classList.remove('hidden');
            document.getElementById(`btn-${section}-${index}`).classList.add('active-tab');
        }

        async function refreshData() {
            if(API_URL.includes('GANTIKAN')) {
                alert("Sila masukkan URL API Web App dalam kod!");
                return;
            }
            toggleLoader(true);
            try {
                const response = await fetch(`${API_URL}?action=getBookings`); // Just test one first
                const resBooking = await fetch(`${API_URL}?action=getBookings`).then(r => r.json());
                const resAsset = await fetch(`${API_URL}?action=getAssets`).then(r => r.json());
                const resLoan = await fetch(`${API_URL}?action=getBorrowing`).then(r => r.json());

                // Pastikan kita ambil 'data' dari objek {status, data}
                dataTempahan = resBooking.data || [];
                dataAset = resAsset.data || [];
                dataPinjaman = resLoan.data || [];

                renderBookingTable();
                renderAssetTable();
                renderLoanTable();
                updateLoanDropdown();
            } catch (e) {
                console.error("Ralat Fetch:", e);
            }
            toggleLoader(false);
        }

        async function sendData(payload) {
            toggleLoader(true);
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(payload)
                });
                await new Promise(r => setTimeout(r, 2000)); // Tunggu GAS proses
            } catch (e) { console.error(e); }
            toggleLoader(false);
        }

        function toggleLoader(s) { document.getElementById('loader').classList.toggle('hidden', !s); }

        function renderBookingTable() {
            const tbody = document.getElementById('table-booking-body');
            tbody.innerHTML = dataTempahan.map(b => `<tr class="border-b"><td class="p-3 font-bold">${b[0]}</td><td class="p-3">${b[1]}</td><td class="p-3 text-blue-700">${b[2]}</td></tr>`).join('');
        }

        function renderAssetTable() {
            const tbody = document.getElementById('table-asset-body');
            tbody.innerHTML = dataAset.map(a => `<tr class="border-b"><td class="p-3"><b>${a[1]} ${a[2]}</b><br><span class="text-xs">SN: ${a[4]}</span></td><td class="p-3 text-center"><button onclick="deleteAsset('${a[0]}')" class="bg-red-500 text-white px-3 py-1 rounded text-xs">Hapus</button></td></tr>`).join('');
        }

        function renderLoanTable() {
            const tbody = document.getElementById('table-loan-body');
            tbody.innerHTML = dataPinjaman.map(l => `
                <tr class="border-b">
                    <td class="p-2"><b>${l[1]}</b></td>
                    <td class="p-2">${l[2]}</td>
                    <td class="p-2">${l[5] ? `<span class="text-green-600">Selesai</span>` : `<button onclick="returnItem('${l[0]}','${l[1]}')" class="bg-orange-500 text-white px-2 py-1 rounded text-[10px]">PULANG</button>`}</td>
                </tr>`).join('');
        }

        function updateLoanDropdown() {
            const s = document.getElementById('loan-asset');
            s.innerHTML = '<option value="">-- Pilih Aset --</option>';
            dataAset.forEach(a => {
                s.innerHTML += `<option value="${a[0]}">${a[1]} ${a[2]} (SN: ${a[4]})</option>`;
            });
        }

        async function submitAsset(e) {
            e.preventDefault();
            await sendData({
                action: 'addAsset',
                jenis: document.getElementById('asset-jenis').value,
                jenama: document.getElementById('asset-jenama').value,
                model: document.getElementById('asset-model').value,
                nosiri: document.getElementById('asset-siri').value,
                lokasi: document.getElementById('asset-lokasi').value,
                catatan: ''
            });
            e.target.reset();
            refreshData();
            switchTab('inventory', 2);
        }

        async function submitLoan(e) {
            e.preventDefault();
            const sel = document.getElementById('loan-asset');
            await sendData({
                action: 'addBorrow',
                idAset: sel.value,
                aset: sel.options[sel.selectedIndex].text,
                nama: document.getElementById('loan-nama').value,
                tarikh: document.getElementById('loan-tarikh').value,
                tujuan: document.getElementById('loan-tujuan').value
            });
            e.target.reset();
            refreshData();
        }

        async function returnItem(id, nama) {
            if(!confirm("Sahkan pemulangan aset?")) return;
            await sendData({
                action: 'returnAsset',
                idAset: id,
                nama: nama,
                tarikhPulang: new Date().toLocaleDateString()
            });
            refreshData();
        }

        async function submitBooking(e) {
            e.preventDefault();
            await sendData({
                action: 'addBooking',
                nama: document.getElementById('book-nama').value,
                tarikh: document.getElementById('book-tarikh').value,
                masa: document.getElementById('book-mula').value + ' - ' + document.getElementById('book-tamat').value
            });
            e.target.reset();
            refreshData();
            switchTab('booking', 2);
        }

        async function deleteAsset(id) {
            if(confirm("Hapus aset ini?")) {
                await sendData({action:'deleteAsset', id:id});
                refreshData();
            }
        }

        function loginAdmin() {
            const pass = prompt("Sila masukkan kata laluan:");
            if(pass === "smkjinjang123") {
                document.getElementById('admin-badge').classList.remove('hidden');
                showView('inventory');
            } else {
                alert("Kata laluan salah!");
            }
        }

        // Slot Masa Logic
        const ALL_SLOTS = ["07:30", "08:00", "08:30", "09:00", "09:30", "10:00", "10:30", "11:00", "11:30", "12:00", "12:30", "13:00", "13:30", "14:00", "14:30", "15:00", "15:30", "16:00", "16:30", "17:00", "17:30"];
        
        function generateStartSlots() {
            const s = document.getElementById('book-mula');
            s.innerHTML = '<option value="">Mula</option>';
            ALL_SLOTS.forEach(sl => {
                s.innerHTML += `<option value="${sl}">${sl}</option>`;
            });
        }
        
        function generateEndSlots() {
            const m = document.getElementById('book-mula').value;
            const s = document.getElementById('book-tamat');
            s.innerHTML = '<option value="">Tamat</option>';
            const idx = ALL_SLOTS.indexOf(m);
            for(let i=idx+1; i<ALL_SLOTS.length; i++) {
                s.innerHTML += `<option value="${ALL_SLOTS[i]}">${ALL_SLOTS[i]}</option>`;
            }
        }
    </script>
</body>
</html>