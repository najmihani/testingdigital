<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital ICT SMK Jinjang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Pustaka Signature Pad untuk tanda tangan yang lancar -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    <style>
        .hidden { display: none !important; }
        .active-tab { border-bottom: 4px solid #1e40af; color: #1e40af; font-weight: bold; background-color: #f8fafc; }
        .loader { border-top-color: #3498db; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @media print {
            body * { visibility: hidden; }
            #print-section, #print-section * { visibility: visible; }
            #print-section { position: absolute; left: 0; top: 0; width: 100%; display: block !important; }
            .no-print { display: none !important; }
        }

        /* Styling Modal Tanda Tangan */
        #signature-modal {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .signature-container {
            border: 2px dashed #cbd5e1;
            background-color: #f8fafc;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

    <header class="bg-white shadow-sm border-b-4 border-blue-800 p-4 no-print">
        <div class="container mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="flex items-center gap-4">
                <img src="https://i.ibb.co/Lhb8pYQ/SMK-Jinjang.jpg" alt="Logo" class="h-20 w-auto rounded shadow-sm">
                <div>
                    <h1 class="text-2xl font-black text-blue-900 tracking-tight uppercase">Digital ICT SMK Jinjang</h1>
                    <p id="display-date" class="text-gray-500 text-sm font-medium"></p>
                </div>
            </div>
            <div id="admin-badge" class="hidden bg-red-100 text-red-700 px-4 py-1 rounded-full text-xs font-bold border border-red-200 uppercase">Admin Mode</div>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8 no-print">

        <div id="view-home" class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-10">
            <div onclick="showView('booking')" class="bg-white p-10 rounded-2xl shadow-xl hover:shadow-2xl hover:scale-[1.02] transition-all cursor-pointer border-t-8 border-blue-600 group text-center">
                <div class="text-6xl mb-4">üìÖ</div>
                <h2 class="text-2xl font-bold text-slate-800 uppercase">Sistem Tempahan Makmal</h2>
                <p class="text-slate-500 mt-2">Semak jadual dan buat tempahan makmal.</p>
            </div>
            <div onclick="loginAdmin()" class="bg-white p-10 rounded-2xl shadow-xl hover:shadow-2xl hover:scale-[1.02] transition-all cursor-pointer border-t-8 border-emerald-600 group text-center">
                <div class="text-6xl mb-4">üì¶</div>
                <h2 class="text-2xl font-bold text-slate-800 uppercase">Sistem Inventori & Aset</h2>
                <p class="text-slate-500 mt-2">Daftar aset dan urus pinjaman peralatan.</p>
            </div>
        </div>

        <div id="view-booking" class="hidden">
            <button onclick="showView('home')" class="mb-4 text-blue-600 font-bold hover:underline uppercase">‚Üê Menu Utama</button>
            <div class="bg-white rounded-xl shadow-lg overflow-hidden border">
                <div class="flex bg-slate-100 border-b">
                    <button id="btn-booking-1" onclick="switchTab('booking', 1)" class="flex-1 py-4 font-bold uppercase">Borang</button>
                    <button id="btn-booking-2" onclick="switchTab('booking', 2)" class="flex-1 py-4 font-bold uppercase">Rekod & Laporan</button>
                </div>

                <div id="tab-booking-1" class="p-6">
                    <div class="max-w-md mx-auto bg-slate-50 p-6 rounded-xl border">
                        <form onsubmit="submitBooking(event)" class="space-y-4">
                            <div><label class="block text-xs font-bold text-gray-500 uppercase">Nama Guru</label><input type="text" id="book-nama" required class="w-full p-3 border rounded-lg"></div>
                            <div><label class="block text-xs font-bold text-gray-500 uppercase">Tarikh</label><input type="date" id="book-tarikh" onchange="generateStartSlots()" required class="w-full p-3 border rounded-lg"></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-xs font-bold text-gray-500 uppercase">Mula</label><select id="book-mula" onchange="generateEndSlots()" required class="w-full p-3 border rounded-lg"><option value="">Pilih Tarikh Dahulu</option></select></div>
                                <div><label class="block text-xs font-bold text-gray-500 uppercase">Tamat</label><select id="book-tamat" required class="w-full p-3 border rounded-lg"><option value="">Mula Dahulu</option></select></div>
                            </div>
                            <button type="submit" class="w-full bg-blue-700 text-white font-bold py-4 rounded-lg uppercase tracking-widest">Sahkan Tempahan</button>
                        </form>
                    </div>
                </div>

                <div id="tab-booking-2" class="hidden p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 bg-slate-50 p-4 rounded-lg border">
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1 uppercase">Cari Mengikut Tarikh</label>
                            <div class="flex gap-2">
                                <input type="date" id="search-date-booking" class="flex-1 p-2 border rounded">
                                <button onclick="filterBookingByDate()" class="bg-slate-700 text-white px-4 py-2 rounded text-xs font-bold uppercase">Cari</button>
                                <button onclick="renderBookingTable(dataTempahan)" class="bg-gray-400 text-white px-4 py-2 rounded text-xs font-bold uppercase">Semua</button>
                            </div>
                        </div>
                        <div class="border-t md:border-t-0 md:border-l pt-4 md:pt-0 md:pl-4">
                            <label class="block text-xs font-bold text-blue-800 mb-1 uppercase">Cetak Laporan Bulanan</label>
                            <div class="flex gap-2">
                                <input type="month" id="print-month-select" class="flex-1 p-2 border rounded border-blue-200">
                                <button onclick="printMonthlyBooking()" class="bg-blue-800 text-white px-6 py-2 rounded font-bold uppercase text-xs">üñ®Ô∏è Cetak</button>
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-800 text-white"><tr><th class="p-3">Nama Guru</th><th class="p-3">Tarikh</th><th class="p-3">Masa</th></tr></thead>
                            <tbody id="table-booking-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-inventory" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <button onclick="showView('home')" class="text-blue-600 font-bold hover:underline uppercase">‚Üê Keluar</button>
                <div class="flex bg-gray-200 rounded-lg p-1 text-xs font-bold gap-1">
                    <button id="btn-inventory-1" onclick="switchTab('inventory', 1)" class="px-4 py-2 rounded-md uppercase">Daftar/Edit</button>
                    <button id="btn-inventory-2" onclick="switchTab('inventory', 2)" class="px-4 py-2 rounded-md uppercase">Senarai</button>
                    <button id="btn-inventory-3" onclick="switchTab('inventory', 3)" class="px-4 py-2 rounded-md uppercase">Pinjaman</button>
                </div>
            </div>

            <div id="tab-inventory-1" class="hidden bg-white p-6 rounded-xl shadow border">
                <h3 id="asset-form-title" class="font-bold text-blue-900 uppercase mb-4">Pendaftaran Aset</h3>
                <form onsubmit="submitAsset(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="hidden" id="asset-id">
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold text-gray-500 uppercase">Jenis Aset</label>
                        <select id="asset-jenis" required class="w-full p-3 border rounded-lg">
                            <option value="">-- Pilih Jenis --</option>
                            <option value="Komputer">Komputer</option>
                            <option value="Laptop">Laptop</option>
                            <option value="Printer">Printer</option>
                            <option value="Toner/Ink">Toner/Ink</option>
                            <option value="Lain-lain">Lain-lain</option>
                        </select>
                    </div>
                    <div><label class="block text-xs font-bold uppercase">Jenama</label><input type="text" id="asset-jenama" required class="w-full p-3 border rounded-lg"></div>
                    <div><label class="block text-xs font-bold uppercase">Model</label><input type="text" id="asset-model" required class="w-full p-3 border rounded-lg"></div>
                    <div><label class="block text-xs font-bold uppercase">No Siri</label><input type="text" id="asset-siri" required class="w-full p-3 border rounded-lg"></div>
                    <div><label class="block text-xs font-bold uppercase">Lokasi</label><input type="text" id="asset-lokasi" required class="w-full p-3 border rounded-lg"></div>
                    <div class="md:col-span-2 flex gap-2">
                        <button type="submit" id="btn-asset-save" class="flex-1 bg-emerald-700 text-white font-bold py-3 rounded-lg uppercase">Simpan</button>
                        <button type="button" id="btn-asset-cancel" onclick="resetAssetForm()" class="hidden bg-gray-500 text-white font-bold px-6 rounded-lg">Batal</button>
                    </div>
                </form>
            </div>

            <div id="tab-inventory-2" class="hidden bg-white p-6 rounded-xl shadow border">
                 <table class="w-full text-sm text-left"><thead class="bg-slate-800 text-white"><tr><th class="p-3">Maklumat Aset</th><th class="p-3 text-center">Tindakan</th></tr></thead><tbody id="table-asset-body"></tbody></table>
            </div>

            <div id="tab-inventory-3" class="hidden space-y-4">
                <div class="bg-white p-6 rounded-xl shadow border">
                    <div class="flex justify-between items-center mb-4"><h3 class="font-bold uppercase">Borang Pinjaman</h3><button onclick="printAllLoans()" class="bg-black text-white px-4 py-2 rounded text-xs font-bold uppercase tracking-widest">üñ®Ô∏è Cetak Semua Rekod</button></div>
                    <form onsubmit="submitLoan(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 p-4 bg-slate-50 border-2 border-dashed rounded-lg">
                        <div><label class="block text-xs font-bold uppercase">Peminjam</label><input type="text" id="loan-nama" required class="w-full p-3 border rounded-lg"></div>
                        <div>
                            <label class="block text-xs font-bold uppercase">Pilih Aset (Cari Model/SN)</label>
                            <input type="text" id="loan-asset-search" onkeyup="filterLoanAssets()" placeholder="Taip untuk cari..." class="w-full p-2 mb-1 border rounded text-xs border-blue-300 outline-none focus:border-blue-600">
                            <select id="loan-asset" required class="w-full p-3 border rounded-lg"></select>
                        </div>
                        <div><label class="block text-xs font-bold uppercase">Tarikh</label><input type="date" id="loan-tarikh" required class="w-full p-3 border rounded-lg"></div>
                        <div><label class="block text-xs font-bold uppercase">Tujuan</label><input type="text" id="loan-tujuan" required class="w-full p-3 border rounded-lg"></div>
                        <button type="submit" class="md:col-span-2 bg-blue-700 text-white font-bold py-3 rounded-lg uppercase">Daftar Pinjaman</button>
                    </form>
                    <div class="overflow-x-auto"><table class="w-full text-xs text-left"><thead class="bg-gray-100"><tr><th class="p-2">Nama</th><th class="p-2">Aset</th><th class="p-2">Tarikh</th><th class="p-2">Status</th><th class="p-2">Bukti</th></tr></thead><tbody id="table-loan-body"></tbody></table></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Tanda Tangan (Pop-up) -->
    <div id="signature-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden">
            <div class="bg-blue-800 p-4 text-white">
                <h3 class="font-bold uppercase tracking-tight">Pengesahan Pemulangan</h3>
                <p class="text-xs opacity-75">Sila turunkan tanda tangan di bawah sebagai bukti pemulangan.</p>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <p id="sign-info" class="text-sm font-bold text-gray-700 mb-2"></p>
                    <div class="signature-container rounded-lg overflow-hidden">
                        <canvas id="signature-pad" class="w-full h-48 cursor-crosshair"></canvas>
                    </div>
                    <button onclick="clearSignature()" class="mt-2 text-xs text-red-600 font-bold uppercase hover:underline">Padam Semula</button>
                </div>
                <div class="flex gap-2">
                    <button onclick="closeSignatureModal()" class="flex-1 bg-gray-200 text-gray-700 font-bold py-3 rounded-lg uppercase text-sm">Batal</button>
                    <button onclick="confirmReturnWithSign()" class="flex-1 bg-green-600 text-white font-bold py-3 rounded-lg uppercase text-sm">Hantar & Pulang</button>
                </div>
            </div>
        </div>
    </div>

    <div id="print-section" class="hidden"></div>
    <div id="loader" class="hidden fixed inset-0 bg-white/80 flex flex-col items-center justify-center z-50">
        <div class="loader rounded-full border-8 border-t-8 border-blue-200 h-16 w-16 mb-2"></div>
        <p class="font-bold text-blue-900 uppercase text-xs">Memproses Data...</p>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzY7IBogaK_Owp0OM0Wanz-fI_3fFNgeT4rp0wSd8DApIdG0fym_PSdioIOZ-PV4Oh-GQ/exec';
        let dataTempahan = [], dataAset = [], dataPinjaman = [];
        let signaturePad;
        let activeReturnData = null;

        window.onload = () => {
            document.getElementById('display-date').innerText = new Date().toLocaleDateString('ms-MY', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            // Inisialisasi Signature Pad
            const canvas = document.getElementById('signature-pad');
            signaturePad = new SignaturePad(canvas, {
                backgroundColor: 'rgba(255, 255, 255, 0)',
                penColor: 'rgb(0, 0, 0)'
            });

            // Resizer untuk canvas supaya saiznya betul
            window.addEventListener("resize", resizeCanvas);
            resizeCanvas();
        };

        function resizeCanvas() {
            const canvas = document.getElementById('signature-pad');
            const ratio =  Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            signaturePad.clear();
        }

        function showView(viewId) {
            ['home', 'booking', 'inventory'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
            document.getElementById(`view-${viewId}`).classList.remove('hidden');
            refreshData();
        }

        function switchTab(section, index) {
            const max = (section === 'booking') ? 2 : 3;
            for(let i=1; i<=max; i++) {
                document.getElementById(`tab-${section}-${i}`).classList.add('hidden');
                document.getElementById(`btn-${section}-${i}`).classList.remove('active-tab');
            }
            document.getElementById(`tab-${section}-${index}`).classList.remove('hidden');
            document.getElementById(`btn-${section}-${index}`).classList.add('active-tab');
            
            if(section === 'inventory' && index === 3) {
                setTimeout(() => document.getElementById('loan-asset-search').focus(), 100);
            }
        }

        async function refreshData() {
            if(API_URL.includes('GANTIKAN')) return;
            toggleLoader(true);
            try {
                const [r1, r2, r3] = await Promise.all([
                    fetch(`${API_URL}?action=getBookings`).then(res => res.json()),
                    fetch(`${API_URL}?action=getAssets`).then(res => res.json()),
                    fetch(`${API_URL}?action=getBorrowing`).then(res => res.json())
                ]);
                dataTempahan = r1; dataAset = r2; dataPinjaman = r3;
                renderBookingTable(dataTempahan); renderAssetTable(); renderLoanTable(); updateLoanDropdown();
            } catch (e) { console.error(e); }
            toggleLoader(false);
        }

        function filterBookingByDate() {
            const dateVal = document.getElementById('search-date-booking').value;
            if(!dateVal) return alert("Pilih tarikh!");
            const d = new Date(dateVal);
            const formatted = `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
            const filtered = dataTempahan.filter(b => b[1] === formatted || b[1] === dateVal);
            renderBookingTable(filtered);
        }

        function renderBookingTable(list) {
            const tbody = document.getElementById('table-booking-body');
            tbody.innerHTML = list.slice().reverse().map(b => `<tr class="border-b hover:bg-slate-50"><td class="p-3 font-bold">${b[0]}</td><td class="p-3">${b[1]}</td><td class="p-3 text-blue-700 font-mono">${b[2]}</td></tr>`).join('');
            if(list.length === 0) tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-400 italic">Tiada rekod dijumpai</td></tr>';
        }

        function renderLoanTable() {
            const tbody = document.getElementById('table-loan-body');
            tbody.innerHTML = dataPinjaman.slice().reverse().map(l => {
                const isReturned = !!l[5];
                const signImg = l[6] ? `<img src="${l[6]}" class="h-8 border bg-white" title="Lihat Tanda Tangan" onclick="viewLargeSign('${l[6]}')">` : '-';
                
                return `<tr class="border-b hover:bg-slate-50">
                    <td class="p-2 font-bold">${l[1]}</td>
                    <td class="p-2">${l[2]}</td>
                    <td class="p-2 font-mono">${l[3]}</td>
                    <td class="p-2 text-center">
                        ${isReturned ? '<span class="text-green-600 font-bold">PULANG</span>' : `<button onclick="openSignatureModal('${l[0]}','${l[1]}')" class="bg-orange-500 text-white px-2 py-1 rounded font-bold">PULANG</button>`}
                    </td>
                    <td class="p-2 flex justify-center">${signImg}</td>
                </tr>`;
            }).join('');
        }

        // --- FUNGSI TANDA TANGAN ---
        function openSignatureModal(id, nama) {
            activeReturnData = { id, nama };
            document.getElementById('sign-info').innerText = `Peminjam: ${nama}`;
            document.getElementById('signature-modal').classList.remove('hidden');
            signaturePad.clear();
            setTimeout(resizeCanvas, 100); // Pastikan saiz canvas betul dalam modal
        }

        function closeSignatureModal() {
            document.getElementById('signature-modal').classList.add('hidden');
            activeReturnData = null;
        }

        function clearSignature() {
            signaturePad.clear();
        }

        async function confirmReturnWithSign() {
            if (signaturePad.isEmpty()) {
                return alert("Sila turunkan tanda tangan terlebih dahulu!");
            }

            const t = new Date().toISOString().split('T')[0];
            const signatureData = signaturePad.toDataURL(); // Ambil Base64 imej

            toggleLoader(true);
            await sendData({
                action: 'returnAsset', 
                idAset: activeReturnData.id, 
                nama: activeReturnData.nama, 
                tarikhPulang: t,
                tandaTangan: signatureData // Hantar data imej ke backend
            });
            
            closeSignatureModal();
            refreshData();
        }

        function viewLargeSign(url) {
            // Paparan ringkas untuk lihat tanda tangan besar
            const win = window.open("");
            win.document.write(`<img src="${url}" style="border:1px solid #000">`);
        }

        // --- FUNGSI LAIN (SAMA SEPERTI ASAL) ---
        function runPrint(htmlContent) {
            const printArea = document.getElementById('print-section');
            printArea.innerHTML = htmlContent;
            window.print();
        }

        function printMonthlyBooking() {
            const monthVal = document.getElementById('print-month-select').value;
            if(!monthVal) return alert("Sila pilih bulan!");
            const [year, month] = monthVal.split('-');
            const monthNames = ["JANUARI", "FEBRUARI", "MAC", "APRIL", "MEI", "JUN", "JULAI", "OGOS", "SEPTEMBER", "OKTOBER", "NOVEMBER", "DISEMBER"];
            const filtered = dataTempahan.filter(b => {
                const parts = b[1].split(/[-/]/);
                const bYear = parts[0].length === 4 ? parts[0] : parts[2];
                const bMonth = parts[1];
                return bYear == year && parseInt(bMonth) == parseInt(month);
            });
            if(filtered.length === 0) return alert("Tiada rekod untuk bulan tersebut.");
            const content = `<div style="text-align:center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px;"><img src="https://i.ibb.co/Lhb8pYQ/SMK-Jinjang.jpg" style="height:70px;"><h2 style="margin: 10px 0;">LAPORAN TEMPAHAN MAKMAL KOMPUTER</h2><h3 style="margin: 0; text-transform: uppercase;">BULAN: ${monthNames[parseInt(month)-1]} ${year}</h3></div><table style="width:100%; border-collapse: collapse;"><thead><tr style="background: #eee;"><th style="border: 1px solid #000; padding: 8px;">TARIKH</th><th style="border: 1px solid #000; padding: 8px;">NAMA GURU</th><th style="border: 1px solid #000; padding: 8px;">WAKTU</th></tr></thead><tbody>${filtered.map(b => `<tr><td style="border: 1px solid #000; padding: 8px; text-align:center;">${b[1]}</td><td style="border: 1px solid #000; padding: 8px;">${b[0]}</td><td style="border: 1px solid #000; padding: 8px; text-align:center;">${b[2]}</td></tr>`).join('')}</tbody></table>`;
            runPrint(content);
        }

        function printAllLoans() {
            if(dataPinjaman.length === 0) return alert("Tiada rekod pinjaman.");
            const content = `<div style="text-align:center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px;"><img src="https://i.ibb.co/Lhb8pYQ/SMK-Jinjang.jpg" style="height:70px;"><h2 style="margin: 10px 0;">REKOD KESELURUHAN PINJAMAN ASET ICT</h2></div><table style="width:100%; border-collapse: collapse; font-size: 11px;"><thead><tr style="background: #eee;"><th style="border: 1px solid #000; padding: 5px;">PEMINJAM</th><th style="border: 1px solid #000; padding: 5px;">ASET</th><th style="border: 1px solid #000; padding: 5px;">TARIKH PINJAM</th><th style="border: 1px solid #000; padding: 5px;">TARIKH PULANG</th></tr></thead><tbody>${dataPinjaman.map(l => `<tr><td style="border: 1px solid #000; padding: 5px;">${l[1]}</td><td style="border: 1px solid #000; padding: 5px;">${l[2]}</td><td style="border: 1px solid #000; padding: 5px; text-align:center;">${l[3]}</td><td style="border: 1px solid #000; padding: 5px; text-align:center;">${l[5] || '-'}</td></tr>`).join('')}</tbody></table>`;
            runPrint(content);
        }

        function renderAssetTable() {
            const tbody = document.getElementById('table-asset-body');
            tbody.innerHTML = dataAset.map(a => `<tr class="border-b"><td class="p-3 text-sm"><b>[${a[3]}]</b> ${a[1]} ${a[2]}<br><span class="text-xs text-gray-400">SN: ${a[4]} | Loc: ${a[5]}</span></td><td class="p-3 text-center flex flex-col gap-1 items-center"><button onclick="editAsset('${a[0]}')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold uppercase w-20">Edit</button><button onclick="deleteAsset('${a[0]}')" class="bg-red-500 text-white px-3 py-1 rounded text-xs font-bold uppercase w-20">Hapus</button></td></tr>`).join('');
        }

        function updateLoanDropdown() {
            const s = document.getElementById('loan-asset'); if(!s) return;
            s.innerHTML = '<option value="">-- Pilih Aset --</option>';
            const onLoan = dataPinjaman.filter(l => !l[5]).map(l => l[0].toString());
            dataAset.forEach(a => { if(!onLoan.includes(a[0].toString())) { const displayText = `${a[1]} ${a[2]} [SN: ${a[4]}]`.toUpperCase(); s.innerHTML += `<option value="${a[0]}">${displayText}</option>`; } });
            document.getElementById('loan-asset-search').value = '';
        }

        function filterLoanAssets() {
            const input = document.getElementById('loan-asset-search').value.toUpperCase();
            const select = document.getElementById('loan-asset');
            const options = select.getElementsByTagName('option');
            for (let i = 1; i < options.length; i++) {
                const txtValue = options[i].textContent || options[i].innerText;
                options[i].style.display = (txtValue.toUpperCase().indexOf(input) > -1) ? "" : "none";
            }
        }

        async function submitAsset(e) { e.preventDefault(); const id = document.getElementById('asset-id').value; await sendData({ action: id ? 'updateAsset' : 'addAsset', id:id, jenis: document.getElementById('asset-jenis').value, jenama: document.getElementById('asset-jenama').value, model: document.getElementById('asset-model').value, nosiri: document.getElementById('asset-siri').value, lokasi: document.getElementById('asset-lokasi').value }); resetAssetForm(); refreshData(); switchTab('inventory', 2); }
        function editAsset(id) { const a = dataAset.find(x => x[0].toString() === id.toString()); if(!a) return; document.getElementById('asset-id').value = a[0]; document.getElementById('asset-jenama').value = a[1]; document.getElementById('asset-model').value = a[2]; document.getElementById('asset-jenis').value = a[3]; document.getElementById('asset-siri').value = a[4]; document.getElementById('asset-lokasi').value = a[5]; document.getElementById('asset-form-title').innerText = "Kemaskini Aset"; document.getElementById('btn-asset-save').innerText = "KEMASKINI"; document.getElementById('btn-asset-cancel').classList.remove('hidden'); switchTab('inventory', 1); }
        function resetAssetForm() { document.getElementById('asset-id').value = ''; document.getElementById('asset-form-title').innerText = "Pendaftaran Aset"; document.getElementById('btn-asset-save').innerText = "SIMPAN"; document.getElementById('btn-asset-cancel').classList.add('hidden'); document.querySelector('#tab-inventory-1 form').reset(); }
        async function submitLoan(e) { e.preventDefault(); const sel = document.getElementById('loan-asset'); if(!sel.value) return alert("Sila pilih aset!"); await sendData({ action: 'addBorrow', idAset: sel.value, aset: sel.options[sel.selectedIndex].text, nama: document.getElementById('loan-nama').value, tarikh: document.getElementById('loan-tarikh').value, tujuan: document.getElementById('loan-tujuan').value }); e.target.reset(); refreshData(); }
        async function submitBooking(e) { e.preventDefault(); await sendData({ action: 'addBooking', nama: document.getElementById('book-nama').value, tarikh: document.getElementById('book-tarikh').value, masa: document.getElementById('book-mula').value + ' - ' + document.getElementById('book-tamat').value }); e.target.reset(); refreshData(); switchTab('booking', 2); }
        async function deleteAsset(id) { if(confirm("Hapus?")) { await sendData({action:'deleteAsset', id:id}); refreshData(); } }
        function loginAdmin() { if(prompt("Pass:") === "smkjinjang123") { document.getElementById('admin-badge').classList.remove('hidden'); showView('inventory'); } }
        async function sendData(p) { toggleLoader(true); await fetch(API_URL, {method:'POST', mode:'no-cors', body:JSON.stringify(p)}); await new Promise(r=>setTimeout(r,1500)); toggleLoader(false); }
        function toggleLoader(s) { document.getElementById('loader').classList.toggle('hidden', !s); }

        // --- LOGIK MASA ---
        const ALL_SLOTS = []; let st = new Date(2000, 0, 1, 7, 0); for(let i=0; i<24; i++) { ALL_SLOTS.push(st.toTimeString().substring(0, 5)); st.setMinutes(st.getMinutes() + 30); }
        function getBookedSlotsForDate(selectedDate) {
            const d = new Date(selectedDate);
            const formatted = `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
            const booked = [];
            dataTempahan.forEach(b => {
                if (b[1] === formatted || b[1] === selectedDate) {
                    const range = b[2].split(' - ');
                    const startIdx = ALL_SLOTS.indexOf(range[0]);
                    const endIdx = ALL_SLOTS.indexOf(range[1]);
                    for (let i = startIdx; i < endIdx; i++) { booked.push(ALL_SLOTS[i]); }
                }
            });
            return booked;
        }
        function generateStartSlots() { const dateVal = document.getElementById('book-tarikh').value; const s = document.getElementById('book-mula'); if(!dateVal) { s.innerHTML = '<option value="">Pilih Tarikh Dahulu</option>'; return; } const booked = getBookedSlotsForDate(dateVal); s.innerHTML = '<option value="">Mula</option>'; ALL_SLOTS.forEach(sl => { if (!booked.includes(sl)) { s.innerHTML += `<option value="${sl}">${sl}</option>`; } }); document.getElementById('book-tamat').innerHTML = '<option value="">Mula Dahulu</option>'; }
        function generateEndSlots() { const m = document.getElementById('book-mula').value; const dateVal = document.getElementById('book-tarikh').value; const s = document.getElementById('book-tamat'); s.innerHTML = '<option value="">Tamat</option>'; if(!m || !dateVal) return; const booked = getBookedSlotsForDate(dateVal); const idx = ALL_SLOTS.indexOf(m); for(let i=idx+1; i<ALL_SLOTS.length; i++) { if (booked.includes(ALL_SLOTS[i-1])) break; s.innerHTML += `<option value="${ALL_SLOTS[i]}">${ALL_SLOTS[i]}</option>`; } }
    </script>
</body>
</html>